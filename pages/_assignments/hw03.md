---
layout: assignment-two-column
title: "PhotoApp: Make a REST API"
abbreviation: HW3
type: homework
due_date: 2022-02-01
ordering: 3
draft: 1
points: 25
---
<style>
    .condensed li {
        margin-bottom: 2px;
        line-height: 1.5em;
    }
    table li {
        margin-bottom: 0px;
    }
    .emphasize {
        font-weight: 700;
        color: #e76610;
    }
</style>
## Readings:
1. <a href="https://itnext.io/start-using-env-for-your-flask-project-and-stop-using-environment-variables-for-development-247dc12468be" target="_blank">Organizing environment variables</a> using the `.env` file.

## 1. Introduction
For homework 3, you are going to create a REST API using Flask and PostgreSQL. To do this, you will:

{:.condensed}
1. Connect your code to a local database
2. Use SQL Alchemy to interact with your database via python
3. Use Flask RESTful to implement a few API endpoints
4. Run the tests to see that your API requirements have been met
5. Deploy your code to Heroku

Before we begin, we will review a few concepts that you need to understand how the various pieces of this application work together:

### 1. SQL Alchemy
As stated on the <a href="https://www.sqlalchemy.org/" target="_blank">SQL Alchemy project page</a>: "SQLAlchemy is the Python SQL toolkit and Object Relational Mapper that gives application developers the full power and flexibility of SQL." In other words, SQL Alchemy is a python abstraction that makes communication with databases easier. It is database agnostic, meaing that you use the same commands, regardless of whether you're interacting with PostgreSQL, SQLite, MySQL, or some other relational database.

#### What is an Object Relational Mapping (ORM)?
ORMs allow a programmer to associate user-defined Python classes with database tables, and instances of those classes (objects) with rows in their corresponding tables (<a href="https://docs.sqlalchemy.org/en/14/orm/tutorial.html" target="_blank">more on ORM here</a>). For instance, if I wanted to create object mapping to the `posts` table, I could create the following class (the `db` comes from the SQL Alchemy library):

```python
class Post(db.Model):

    # name of table I want to connect to:
    __tablename__ = 'posts'

    # reference to the columns with which I want the application
    # to interact:
    id = db.Column(db.Integer, primary_key=True)
    image_url = db.Column(db.String(200), nullable=False)
    caption = db.Column(db.Text, nullable=True)
    alt_text = db.Column(db.Text, nullable=True)
    pub_date = db.Column(db.DateTime, nullable=False,
        default=datetime.utcnow)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id', ondelete='cascade'),
        nullable=False)

    # convenience methods that allow me to join to other tables:
    user = db.relationship(
        'User', 
        backref="posts", 
        lazy=False
    )
    comments = db.relationship(
        'Comment', 
        cascade="all,delete-orphan", 
        lazy='select', 
        backref=db.backref('posts', lazy='joined')
    )

    # constructor function for creating new "post" records in the DB
    def __init__(self, image_url, user_id, caption=None, alt_text=None, pub_date=None):
        self.image_url = image_url
        self.user_id = user_id
        self.caption = caption
        self.alt_text = alt_text
        self.pub_date = pub_date
```

After creating this class, I can then use it to create, read, update, and delete. Some examples of how you would perform each of these operations are listed below:

#### Create new Post
In SQL Alchemy, you create a record just like you would create any object. The only difference is that you have to add and commit the object to the database:

```python
from models import Post, db

# 1. Create:
new_post = Post(
    image_url='https://picsum.photos/600/430?id=668',
    user_id=3, # must be a valid user_id or will throw an error
    caption='Some caption text',
    alt_text='Some alt text'
)
db.session.add(new_post) # issues the insert statement
db.commit() # commits the change to the database 
```

#### Simple Queries (read operations) with <span class="emphasize">FLASK</span> SQL Alchemy
Just like in SQL, querying operations can be the most complex, as you often want to filter, join, and aggregate data. We will be using the Flask SQL Alchemy library for simple queries (<a href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/queries/" target="_blank">Flask SQL Alchemy documentation here</a>).

```python
from models import Post, db

# get all of the posts:
posts = Post.query.all()

# limit the # of posts:
posts = Post.query.limit(10).all()

# filter the posts (simple):
posts = Post.query.filter_by(user_id=5).all()

# filter the posts (by attribute of a joined table):
posts = Post.query.filter(Post.user.has(username='chad_marks')).all()

# get single post:
post = Post.query.get(5)

# get the user of a post (from the users table)
post.user

# get all of the comments on a post (from the comments table)
post.comments
```

#### Advanced Queries with <span class="emphasize">REGULAR</span> SQL Alchemy
For more advanced queries, you can also use the regular SQL Alchemy documentation (<a href="https://docs.sqlalchemy.org/en/14/orm/tutorial.html" target="_blank">SQL Alchemy documentation here</a>). Some samples are pasted below:

```python
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from models import Post

# set up connection to the database and database session:
connection_string = os.environ.get('DB_URL')
if connection_string is None:
    connection_string = 'postgresql://{user}:{password}@{host}/{database}'.format(
        user=os.environ.get('DB_USERNAME'), 
        password=os.environ.get('DB_PASSWORD'),
        host=os.environ.get('DB_HOST'),
        database=os.environ.get('DB_NAME')
    )

engine = create_engine(connection_string)
Session = sessionmaker(bind=engine)
session = Session()


# get all posts:
posts = session.query(Post).order_by(Post.user_id).all()
```


#### Update Post
```python
from models import Post, db

post = Post.query.get(5)

post.image_url = 'https://picsum.photos/600/430?id=443'
post.caption = 'Updated caption'
post.alt_text = 'Updated alt text'

# commit changes:
db.session.commit() 
```

#### Delete Post
```python
from models import Post, db

Post.query.filter_by(id=5).delete()
db.session.commit()

post = Post.query.get(5) # should return None
```



### 2. The .env file
The `.env` file is a convenient way to set environment variables that can be loaded by your flask application on startup. Because the `.env` file stores sensitive information, this file is typically not checked into git and is excluded from version control by the `.gitignore` file. You will use this file to set database configuration settings.

### 3. Flask RESTful


### 4. Working with the automated tests


### 5. Deploying to Heroku

TODO
1. Instructions for connecting Flask to postgreSQL database
1. Populate model data
1. Create endpoints
    * solutions
    * tests
    * instructions
1. Deploy to Heroku

Post:
* create new post
* delete post
* display post
* display posts (mine and my friends)
* display posts (just mine)

Comment:
* create new comment
* delete comment

LikePost:
* Optional

LikeComment:
* Optional

BookmarkPost:
* Optional

## Your Tasks

### 1. General Guidelines

#### 1. Data Structures

##### Post
YYY
```json

```

##### User
YYY
```json

```

##### Comment
YYY
```json

```

#### 2. Security
Business Logic:


#### 3. HTTP Status Codes


### 1. Implement the following GET routes (8 Points)
The links included below point to a deployment of the hw03 solutions.
<table>
    <thead>
        <tr>
            <th>Method/Route</th>
            <th>Description and Examples</th>
            <th>Parameters</th>
            <th>Response Type</th>
            <th>Points</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>GET /api/posts</td>
            <td>
                All posts in the current users' feed. This includes the current user's posts, as well as the people that the current user is following.
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/posts">/api/posts</a></li>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/posts?limit=5">/api/posts?limit=5</a></li>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/posts?username=jasmine_ortiz">/api/posts?username=jasmine_ortiz</a></li>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/posts?username=jasmine_ortiz&limit=2">/api/posts?username=jasmine_ortiz&limit=2</a></li>
                </ul>
            </td>
            <td>
                <ul>
                    <li><code class="highlighter-rouge">username (string, optional)</code> Only shows posts that were created by the requested user.</li>
                    <li><code class="highlighter-rouge">limit (int, optional)</code>: Limits the number of posts returned (defaults to 10, maximum is 50)</li>
                </ul>
            </td>
            <td>List of Post Objects</td>
            <td>?</td>
        </tr>
        <tr>
            <td>GET /api/posts/&lt;int:id&gt;</td>
            <td>
                The post associated with the id
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/posts/8">/api/posts/8</a></li>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/posts/6">/api/posts/6</a></li>
                </ul>
            </td>
            <td></td>
            <td>Post Object</td>
            <td>?</td>
        </tr>
        <tr>
            <td>GET /api/followers</td>
            <td>
                Users who are following the current user.
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/followers">/api/followers</a></li>
                </ul>
            </td>
            <td></td>
            <td>List of User Objects</td>
            <td>?</td>
        </tr>
        <tr>
            <td>GET /api/following</td>
            <td>
                Users who the current user is following.
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/following">/api/following</a></li>
                </ul>
            </td>
            <td></td>
            <td>List of User Objects</td>
            <td>?</td>
        </tr>
        <tr>
            <td>GET /api/profile</td>
            <td>
                The current user's profile.
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/profile">/api/profile</a></li>
                </ul>
            </td>
            <td></td>
            <td>User Object</td>
            <td>?</td>
        </tr>
    </tbody>
</table>

### Implement POST, PATCH, and DELETE routes
he next set of routes involves storing and manipulating data in your PostgreSQL

#### PATCH and DELETE Notes
Notice that the PATCH and DELETE methods detailed below can fail to find an object if it does not exist within data or if the current user does not have access to it. In these cases, you should mark the status of the response as 404, indicating that the requested resource could not be found.

#### POST Notes
* Receiving two POST requests with identical bodies should create two different objects with distinct ids.
* PostgreSQL will create ids for you automatically.

<table>
    <thead>
        <tr>
            <th>Method/Route</th>
            <th>Description and Examples</th>
            <th>Parameters</th>
            <th>Response Type</th>
            <th>Points</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>POST /api/posts</td>
            <td>
                Should create a new post
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/#">/api/posts</a></li>
                </ul>
            </td>
            <td>
                <ul>
                    <li>image_url: string (required)</li>
                    <li>caption: string</li>
                    <li>alt_text: string</li>
                </ul>
            </td>
            <td>Post Object</td>
            <td>?</td>
        </tr>
        <tr>
            <td>PATCH /api/posts/&lt;int:id&gt;</td>
            <td>
                Should update the post
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/posts/3">/api/posts/3</a></li>
                </ul>
            </td>
            <td>
                <ul>
                    <li>image_url: string (optional)</li>
                    <li>caption: string (optional)</li>
                    <li>alt_text: string (optional)</li>
                </ul>
            </td>
            <td>User Object</td>
            <td>?</td>
        </tr>
        <tr>
            <td>DELETE /api/posts/&lt;int:id&gt;</td>
            <td>
                Should delete the post. Note that the delete is configured to cascade (all associated comments, likes, bookmarks, etc. will also be deleted).
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/posts/3">/api/posts/3</a></li>
                </ul>
            </td>
            <td></td>
            <td>User Object</td>
            <td>?</td>
        </tr>
        <tr>
            <td>POST /api/comments</td>
            <td>
                Should create a new comment
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/#">/api/comments</a></li>
                </ul>
            </td>
            <td>
                <ul>
                    <li>text: string (required)</li>
                    <li>post_id: id (required)</li>
                </ul>
            </td>
            <td>Comment Object</td>
            <td>?</td>
        </tr>
        <tr>
            <td>DELETE /api/comment/&lt;int:id&gt;</td>
            <td>
                Should delete a comment
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/comment/16">/api/comments/55</a></li>
                </ul>
            </td>
            <td></td>
            <td>User Object</td>
            <td>?</td>
        </tr>
        <tr>
            <td>DELETE /api/#</td>
            <td>
                ???
                <ul>
                    <li><a href="https://webdev-winter2022.herokuapp.com/api/#">/api/#</a></li>
                </ul>
            </td>
            <td></td>
            <td>User Object</td>
            <td>?</td>
        </tr>
    </tbody>
</table>