---
layout: assignment-two-column
title: "PhotoApp: Authentication"
abbreviation: HW5
type: homework
due_date: 2022-03-01
ordering: 5
draft: 1
points: 20
---

## 1. Introduction

You are going to implement the following:

### Summary of Tasks

#### Server-Side Logic
1. A "log in" endpoint that will issue a JWT token (`/api/token`).
2. Endpoint security: you will "lock down" all of your API endpoints except for `/api/token` so that they require a valid JWT.
3. You will deprecate the global `current_user` variable, and instead get the user from the JWT token each time you need to use it.

#### Client-Side Logic
1. Create a login form that will send the user's username and password credentials to the `/api/token` endpoint.
1. Store the resulting token in localStorage
1. Embed the header in all of your fetch requests so that you don't get security errors.

## 2. Setup
### 1. Install dependencies:

```bash
# (using whatever approach you have found to work for installing dependencies
pip3 install flask-jwt-extended
```

Also add this line to your `requirements.txt` so that when you deploy your app to Heroku, it will also install the dependency on the Heroku container instance:

```bash
Flask-JWT-Extended==4.3.1
```

### 2. Bugfix to `populate.py`
```python
user.set_password(password) # For me, it's line 63
```
Then run populate to rebuild your database...

### 3. Verify
Copy the tests into your tests folder and run them...

If you see this message, the tests passed!

## 3. Your Tasks


### 1. Create a token endpoint
```python
from models import User
from flask_jwt_extended import create_access_token
from flask import Response, request
from flask_restful import Resource
import json

class TokenEndpoint(Resource):
    # Create a route to authenticate your users and return JWT Token. The
    # create_access_token() function is used to actually generate the JWT.
    def post(self):
        body = request.get_json()
        if not body:
            return Response(json.dumps({"msg": "No data passed"}), mimetype="application/json", status=400)

        username = body.get('username')
        password = body.get('password')
        
        # Query your database for username and password
        user = User.query.filter_by(username=username).first()
        if user is None:
            # the user was not found on the database
            return Response(json.dumps({"msg": "Bad username"}), mimetype="application/json", status=401)
        
        if user.check_password(password):
            # create a new token with the user id inside
            access_token = create_access_token(identity=user.id)
            return Response(json.dumps({ "token": access_token, "user_id": user.id }), mimetype="application/json", status=200)
        else:
            # bad password
            return Response(json.dumps({"msg": "Bad password"}), mimetype="application/json", status=401)

def initialize_routes(api):
    api.add_resource(
        TokenEndpoint, 
        '/api/token', '/api/token/'
    )
```